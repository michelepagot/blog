<!DOCTYPE html>
<html lang="en-us">
	<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="The radare team">
<meta name="description" content="The blog of radare2">
<meta name="generator" content="Hugo 0.74.3" />
<title>Shellshock r2 fix</title>
<link rel="shortcut icon" href="https://radareorg.github.io/blog/images/favicon.ico">
<link rel="stylesheet" href="https://radareorg.github.io/blog/css/style.css">
<link rel="stylesheet" href="https://radareorg.github.io/blog/css/highlight.css">



<link rel="stylesheet" href="https://radareorg.github.io/blog/css/monosocialiconsfont.css">



<link href="https://radareorg.github.io/blog/index.xml" rel="alternate" type="application/rss+xml" title="The Official Radare Blog" />


<meta property="og:title" content="Shellshock r2 fix" />
<meta property="og:description" content="A lot have been discussed recently about this vulnerability in bash. The internet was totally shocked just like what happened with heartbleed.
Several vulnerabilities have been discovered in bash, which caused the distros to release several updates on the same package and being a little chaotic to know which was the correct patch to take.
The vulnerability was not just affecting local users which have a little risk, but webservers running CGIs because http parameters are passed as environment variables to the script which was executing the functions defined in there." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://radareorg.github.io/blog/posts/shellshock-r2-fix/" />
<meta property="article:published_time" content="2014-09-30T02:08:29+02:00" />
<meta property="article:modified_time" content="2014-09-30T02:08:29+02:00" />


<meta itemprop="name" content="Shellshock r2 fix">
<meta itemprop="description" content="A lot have been discussed recently about this vulnerability in bash. The internet was totally shocked just like what happened with heartbleed.
Several vulnerabilities have been discovered in bash, which caused the distros to release several updates on the same package and being a little chaotic to know which was the correct patch to take.
The vulnerability was not just affecting local users which have a little risk, but webservers running CGIs because http parameters are passed as environment variables to the script which was executing the functions defined in there.">
<meta itemprop="datePublished" content="2014-09-30T02:08:29+02:00" />
<meta itemprop="dateModified" content="2014-09-30T02:08:29+02:00" />
<meta itemprop="wordCount" content="828">



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Shellshock r2 fix"/>
<meta name="twitter:description" content="A lot have been discussed recently about this vulnerability in bash. The internet was totally shocked just like what happened with heartbleed.
Several vulnerabilities have been discovered in bash, which caused the distros to release several updates on the same package and being a little chaotic to know which was the correct patch to take.
The vulnerability was not just affecting local users which have a little risk, but webservers running CGIs because http parameters are passed as environment variables to the script which was executing the functions defined in there."/>


    </head>
<body>
    <nav class="main-nav">
	
		<a href='https://radareorg.github.io/blog'> <span class="arrow">‚Üê</span>Home</a>
	

	

	
		<a class="cta" href="https://radareorg.github.io/blog/index.xml">Subscribe</a>
	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>Shellshock r2 fix</h1>
        <h2 class="subtitle"></h2>
        <h2 class="headline">
        September 30, 2014
        <br>
        
        </h2>
    </header>
    <section id="post-body">
        <p>A lot have been discussed recently about this <a href="https://shellshocker.net/">vulnerability</a> in bash. The internet was totally shocked just like what happened with <a href="http://heartbleed.com/">heartbleed</a>.</p>
<p>Several vulnerabilities have been discovered in bash, which caused the distros to release several updates on the same package and being a little chaotic to know which was the correct patch to take.</p>
<p>The vulnerability was not just affecting local users which have a little risk, but webservers running CGIs because http parameters are passed as environment variables to the script which was executing the functions defined in there.</p>
<p>Finally, it seems that the tempest is calming down and everyone is happy again with the GNU Bourne Again Shell.</p>
<p>But vulnerabilities in security are always not correctly patched, or even properly updated all the affected systems. This is the case of critical servers which can&rsquo;t be easily updated or require too much manual intervention like compiling a new version of the shell by hand, etc.</p>
<p>On embedded systems, this is probably the worst place, because they tend to be poorly updated, luckily few embedded systems use bash for memory constrains reasons. But the vulnerable systems are still there.</p>
<p>At the moment of writing Apple didnt released a security update to fix that vulnerability on OSX. So this exposes all the OSX users and servers.</p>
<p>UPDATE: Apple just released an <a href="http://arstechnica.com/apple/2014/09/apple-patches-shellshock-bash-bug-in-os-x-10-9-10-8-and-10-7/">update</a> while I&rsquo;m writing that blog post.</p>
<h2 id="the-binary-patch">The binary patch</h2>
<p>After reading some links I found some people doing <a href="http://www.openwall.com/lists/oss-security/2014/09/29/1">binary patching</a> for fixing the vulnerability (by removing the functionality).</p>
<p>As the comment describes, the patch consists on nullifying the first byte in every search result of &lsquo;() {\x00&rsquo;.</p>
<p>Solar Designer has implemented a Perl oneliner to fix it which is described on <a href="https://www.schneier.com/blog/archives/2014/09/nasty_vulnerabi.html#c6679473">Bruce&rsquo;s blog</a> and also twitted <a href="https://twitter.com/solardiz/status/516370924426514433">here</a>.</p>
<pre><code>perl -pe 's/\(\) {\0/(){\0\0/g' &lt; /bin/bash
</code></pre>
<p>This is a good oportunity for showing how to do this with r2 and explain what the patch does.</p>
<pre><code>r2 -qnwc '/ () {\x00;wx 00@@ *' /bin/bash
</code></pre>
<p>In essence the patch length is the same as in Perl. that give us a quite good compression ratio :)</p>
<p>Let&rsquo;s explain what the r2 oneliner does:</p>
<h2 id="flags">Flags:</h2>
<ul>
<li><code>-q</code> : quit after running all the -c commands</li>
<li><code>-n</code> : do not load rbin information</li>
<li><code>-w</code> : open the file in read-write mode</li>
<li><code>-c</code> : run the following command</li>
</ul>
<h2 id="commands">Commands</h2>
<ul>
<li><code>/ () {\x00</code> : searches the string <code>() {</code> finalized with a null byte.</li>
<li><code>wx 00 @@ *</code> : writes a null byte (Write heX 0x00) at the very first byte of each search hit.</li>
</ul>
<h2 id="patching-osx">Patching OSX</h2>
<p>I have tested this in my local Mac and it worked as expected:</p>
<pre><code>$ /bin/bash --version
GNU bash, version 3.2.51(1)-release (x86_64-apple-darwin13)
Copyright (C) 2007 Free Software Foundation, Inc.
$ cp /bin/bash .
$ env x='() { :;}; echo vulnerable' ./bash -c &quot;:&quot;
vulnerable
$ r2 -qnwc '/ () {\x00;wx 00@@ *' bash
$ env x='() { :;}; echo vulnerable' ./bash -c &quot;:&quot;
$
</code></pre>
<p>If we look closer of what that patch is doing we will notice that in OSX it will be patching that null byte in two places. This is because that bin is a fatmach0 that contains the x86-32 and x86-64 programs. We can extract them with this command:</p>
<pre><code>$ rabin2 -x bash
bash.fat/bash.x86_64.0 created (612336)
bash.fat/bash.x86_32.1 created (609744)
</code></pre>
<p>Here we&rsquo;ll see that each file contains only one result for searching &ldquo;() {\x00&rdquo;.</p>
<h2 id="understanding-the-patch">Understanding the patch</h2>
<p>The patch is chopping a string in an array of them which is used to permit the function definition support on environment variables.</p>
<p>That binary patch is just disabling the functionality that <a href="https://ftp.gnu.org/pub/gnu/bash/bash-3.2-patches/bash32-054">this patch</a> is fixing .</p>
<p>That will make the STREQN conditional to always be true.</p>
<p>As long as this is an exotic functionality I guess the patch will not break any bash script. Anyway it&rsquo;s always good to keep a copy of the original binary before patching it to compare or be able to go back to the previous state.</p>
<h2 id="other-vulnerabilities">Other vulnerabilities</h2>
<p>Other vulnerabilities has been also found in bash caused by not correctly fixing the problem or similar ways to exploit the bug.</p>
<p>You can find them all at <a href="https://shellshocker.net/">here</a>. I&rsquo;ll list them and mark them as FIXED if the patch fixes the problem (tested on OSX)</p>
<p>Should not say &ldquo;vulnerable&rdquo;  (FIXED)</p>
<pre><code>env x='() { :;}; echo vulnerable' bash -c &quot;:&quot;
</code></pre>
<p>Should not display the date  (FIXED)</p>
<pre><code>env X='() { (shellshocker.net)=&gt;\' bash -c &quot;echo date&quot;; cat echo ; rm -f echo
</code></pre>
<p>Should not say &ldquo;vulnerable&rdquo; (FIXED)</p>
<pre><code>env -i X=' () { }; echo vulnerable' bash -c 'date'
</code></pre>
<p>Should not crash (NOT AFFECTED)</p>
<pre><code>bash -c 'true &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF &lt;&lt;EOF' || echo &quot;CVE-2014-7186 vulnerable, redir_stack&quot;
</code></pre>
<p>Shold not display the CVE number (NOT AFFECTED)</p>
<pre><code>(for x in {1..200} ; do echo &quot;for x$x in ; do :&quot;; done; for x in {1..200} ; do echo done ; done) | bash || echo &quot;CVE-2014-7187 vulnerable, word_lineno&quot;
</code></pre>
<p>You can find a script that collects all the patches for bash on <a href="https://github.com/tjluoma/bash-fix/blob/master/bash-fix.sh">this</a> github.</p>
<p>&ndash;pancake</p>

    </section>
</article>

<footer id="post-meta" class="clearfix">
    <a href="https://twitter.com/radareorg">
    <img class="avatar" src="https://radareorg.github.io/blog/images/avatar.png">
    <div>
        <span class="dark">The radare team</span>
        <span></span>
    </div>
    </a>
    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fradareorg.github.io%2fblog%2fposts%2fshellshock-r2-fix%2f - Shellshock%20r2%20fix by @radareorg"><span class="icon-twitter"> https://twitter.com/radareorg</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

    </section>
</footer>



<ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/sleigh_disassembler_backend/">GSoC 2020: SLEIGH Disassembler Backend<aside class="dates">Sep 6 2020</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/rsoc-2019-console-interface-improvement/">RSoC 2019 Final: Console Interface Improvements<aside class="dates">Oct 1 2019</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/rsoc-2019-selection/">Radare2 Summer of Code 2019 Selection Results<aside class="dates">Apr 2 2019</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/radare2-survey/">Radare2 Community Survey Results<aside class="dates">Feb 2 2019</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/radare2-bioinformatics/">Radare2 and bioinformatics: a good match?<aside class="dates">Aug 31 2018</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/cutter_debug/">GSoC 2018 Final: Debugging and Emulation Support for Cutter<aside class="dates">Aug 20 2018</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/cli_improvements/">GSoC 2018 Final: Console Interface Improvementes<aside class="dates">Aug 19 2018</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/gsoc_2018_radeco_cfs/">GSoC 2018: Control Flow Structuring for Radeco-lib<aside class="dates">Aug 12 2018</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/gsoc_2018_radeco_pseudo_c_code_generation/">Gsoc 2018 Radeco Pseudo C Code Generation<aside class="dates">Aug 12 2018</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/type_inference/">GSoC&#39;18 Final: Type inference<aside class="dates">Aug 12 2018</aside></a>
        </li>
    
</ul>



        <footer id="footer">
    
    <p class="small">
    
        The radare team
    
    </p>
</footer>

    </section>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://radareorg.github.io/blog/js/main.js"></script>
<script src="https://radareorg.github.io/blog/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>





</body>
</html>
