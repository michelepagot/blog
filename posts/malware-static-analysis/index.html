<!DOCTYPE html>
<html lang="en-us">
	<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="The radare team">
<meta name="description" content="The blog of radare2">
<meta name="generator" content="Hugo 0.74.3" />
<title>Retrieving configuration of a Remote Administration Tool (Malware) with radare2 statically</title>
<link rel="shortcut icon" href="https://radareorg.github.io/blog/images/favicon.ico">
<link rel="stylesheet" href="https://radareorg.github.io/blog/css/style.css">
<link rel="stylesheet" href="https://radareorg.github.io/blog/css/highlight.css">



<link rel="stylesheet" href="https://radareorg.github.io/blog/css/monosocialiconsfont.css">



<link href="https://radareorg.github.io/blog/index.xml" rel="alternate" type="application/rss+xml" title="The Official Radare Blog" />


<meta property="og:title" content="Retrieving configuration of a Remote Administration Tool (Malware) with radare2 statically" />
<meta property="og:description" content="Introduction This article was written during BSidesLV, BlackHat and Defcon events.
** We highly recommend you to try to do the analysis by yourself before looking at this article. Here is a fake one cfd26988d55294870f2676117cf1307ca4acdf8d **
A remote administration tool (also known as a RAT) is a piece of software that allows a remote &ldquo;operator&rdquo; to control a system as if he has physical access to that system. While desktop sharing and remote administration have many legal uses, such software is usually associated with criminal or malicious activity." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://radareorg.github.io/blog/posts/malware-static-analysis/" />
<meta property="article:published_time" content="2016-08-11T08:30:00+01:00" />
<meta property="article:modified_time" content="2016-08-11T08:30:00+01:00" />


<meta itemprop="name" content="Retrieving configuration of a Remote Administration Tool (Malware) with radare2 statically">
<meta itemprop="description" content="Introduction This article was written during BSidesLV, BlackHat and Defcon events.
** We highly recommend you to try to do the analysis by yourself before looking at this article. Here is a fake one cfd26988d55294870f2676117cf1307ca4acdf8d **
A remote administration tool (also known as a RAT) is a piece of software that allows a remote &ldquo;operator&rdquo; to control a system as if he has physical access to that system. While desktop sharing and remote administration have many legal uses, such software is usually associated with criminal or malicious activity.">
<meta itemprop="datePublished" content="2016-08-11T08:30:00+01:00" />
<meta itemprop="dateModified" content="2016-08-11T08:30:00+01:00" />
<meta itemprop="wordCount" content="663">



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Retrieving configuration of a Remote Administration Tool (Malware) with radare2 statically"/>
<meta name="twitter:description" content="Introduction This article was written during BSidesLV, BlackHat and Defcon events.
** We highly recommend you to try to do the analysis by yourself before looking at this article. Here is a fake one cfd26988d55294870f2676117cf1307ca4acdf8d **
A remote administration tool (also known as a RAT) is a piece of software that allows a remote &ldquo;operator&rdquo; to control a system as if he has physical access to that system. While desktop sharing and remote administration have many legal uses, such software is usually associated with criminal or malicious activity."/>


    </head>
<body>
    <nav class="main-nav">
	
		<a href='https://radareorg.github.io/blog'> <span class="arrow">‚Üê</span>Home</a>
	

	

	
		<a class="cta" href="https://radareorg.github.io/blog/index.xml">Subscribe</a>
	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>Retrieving configuration of a Remote Administration Tool (Malware) with radare2 statically</h1>
        <h2 class="subtitle"></h2>
        <h2 class="headline">
        August 11, 2016
        <br>
        
        </h2>
    </header>
    <section id="post-body">
        <h1 id="introduction">Introduction</h1>
<p>This article was written during <a href="https://www.bsideslv.org">BSidesLV</a>, <a href="https://www.blackhat.com/">BlackHat</a> and <a href="https://www.defcon.org/">Defcon</a> events.</p>
<p>** We highly recommend you to try to do the analysis by yourself before looking at this article. Here is a fake one <a href="https://virustotal.com/en/file/f15985a91b12e015812f7f960eb0abe03d0cd401f54d0088f75cb087776a297c/analysis/">cfd26988d55294870f2676117cf1307ca4acdf8d</a> **</p>
<p>A remote administration tool (also known as a <a href="https://en.wikipedia.org/wiki/Remote_administration_software">RAT</a>) is a piece of software that allows a remote &ldquo;operator&rdquo; to control a system as if he has physical access to that system. While desktop sharing and remote administration have many legal uses, such software is usually associated with criminal or malicious activity. In this example we are going to take a look at <em>Cybergate RAT</em> which have its configuration hardcoded. Our goal is to decrypt and retrieve its configuration.</p>
<p><img src="https://i.imgur.com/q2kML7b.png" alt="Cybergate RAT CnC"></p>
<h1 id="getting-started">Getting started</h1>
<h2 id="hashing">Hashing</h2>
<p>To get the SHA1 you can use <code>rahash2 -a sha1 sample.exe</code> or <code>ph sha1 $s @ 0</code>. The <code>$s</code> variable contains the binary size, see <code>?$?</code> to get the complete list of variable.</p>
<p><img src="https://i.imgur.com/jJB55rE.png" alt=""></p>
<p>See also rahash2 tutorial on</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/aMcGrHM-wig" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h2 id="strings">Strings</h2>
<p>To get the complete list of strings, use
<code>rabin2 -zz sample.exe</code> or <code>[0x0040e1a8]&gt; izz</code>.
You can also get them in json format by appending <code>j</code>, like <code>rabin2 -zzj sample.exe</code> or <code>[0x0040e1a8]&gt; izzj</code>.</p>
<p>You can notice that in the sample there is a huge proportion of <code>###@###</code>. To give you a hint, it is very frequent that basic RAT store their configuration in an encrypted form and use delimiter to seperate the various elements, like <code>###@###http://urlofattacker###@###enableFTP=true###@###</code>. You can also see that this string is stored in the <code>.rsrc.</code> section. If you want more context, you can simply use <code>rafind2 -X -s &quot;###&quot; sample.exe</code>.</p>
<p><img src="https://i.imgur.com/FcQR7hS.png" alt=""></p>
<h2 id="information-of-the-binary">Information of the binary</h2>
<ul>
<li>Get Information: <code>rabin2 -I sample.exe</code> or <code>[0x0040e1a8]&gt; iI</code></li>
<li>Get Entrypoint: <code>rabin2 -e sample.exe</code> or <code>[0x0040e1a8]&gt; ie</code></li>
<li>Get Sections: <code>rabin2 -S sample.exe</code> or <code>iS</code></li>
<li>Get imports: <code>rabin2 -i sample.exe</code> or <code>[0x0040e1a8]&gt; ii</code></li>
<li>Get libraries: <code>rabin2 -L sample.exe</code> or <code>[0x0040e1a8]&gt; iL</code></li>
<li>Get Entropy: <code>rahash2 -B -b 512 -a entropy sample.exe</code> or <code>[0x0040e1a8]&gt; p=e</code></li>
</ul>
<p>You can of course combine everything into one command: <code>-IeiL</code>.</p>
<p>Imports are giving us an indication about what resource are manipulated, you can get them with <code>rabin2 -i sample.exe</code>, as mentionned previously.</p>
<p><img src="https://i.imgur.com/0ZQqv4j.png" alt=""></p>
<h1 id="analysis">Analysis</h1>
<p>We want to open and analyse the binary the dumb way <code>r2 -A</code> (-A is using <code>[0x0040e1a8]&gt; aaa</code> see why it is a bad practice here: <a href="http://radare.today/posts/analysis-by-default/)">http://radare.today/posts/analysis-by-default/)</a>.</p>
<p>We know that the configuration is located in the <code>.rsrc</code> segment. By checking the imports we know that what resources are manipulated: Let see where this takes place by looking at the <em>XREFS</em>.</p>
<p>In the visual mode we can visit <code>VF</code> to get all flags, then go to the <em>hud</em>, using <code>_</code> we can search for <code>LoadResource</code>.</p>
<p><img src="https://i.imgur.com/9jW0kdm.png" alt=""></p>
<p>If you select <code>imp.kernel32.dll_LoadResource</code>, which appears to be a relocation, <code>x</code> is giving us the xref and we can use <code>0</code> shortcut (keyboard) to seek to the first (and only) reference. We can do it again as it was just a relocation and we land on <code>fcn.0040630c</code>.</p>
<p><img src="https://i.imgur.com/gCPavif.png" alt=""></p>
<p>We now use visual graph using <code>V</code> don&rsquo;t forget to activate comment using <code>&quot;</code>.</p>
<p>As we can see this function primary purpose is clearly to load the resource. Let&rsquo;s rename it using <code>r</code> (as in <strong>r</strong>ename) followed by <code>get_resource</code>.</p>
<p>Let see the xref of this function. <code>fcn.00406380</code>. We can see that this function is manipulationg <code>###@###</code> in <code>mov edx, 0x406460 ; &quot;####@####&quot; 0x00406460</code>.</p>
<p><img src="https://i.imgur.com/KQfGEZ8.png" alt=""></p>
<p>If we look at the function called after this using keyboard <code>g</code> followed by the letter in brackets: <code>[a]</code>, <code>[b]</code>.. we can see lot of them looks like garbage but one clearly stand out: .</p>
<p>We can see a loop with a buffer being xored <code>xor dl, 0xbc</code>.</p>
<p><img src="https://i.imgur.com/NRomw6D.png" alt="XOR Routine"></p>
<h1 id="configuration-decryption">Configuration decryption</h1>
<p>We can now proceed decryption the dirty way. First we reopen the binary in raw + write mode using <code>oonn+</code> then we use <code>wox</code> to xor the binary. <code>[0x0040e1a8]&gt; wox 0xbc $s @ 0</code>. Now relaunching the <code>[0x0040e1a8]&gt; izz</code> we can see the decrypted configuration!</p>
<h1 id="next-steps">Next steps</h1>
<p>If you are looking for Malware RAT Family easy to analyze, please check out <a href="https://github.com/kevthehermit/RATDecoders">RATDecoders</a>.</p>
<p>&ndash; Maxime M., Incident Intelligence Analyst @ FireEye (aka <a href="https://twitter.com/Maijin212">Maijin</a>)</p>

    </section>
</article>

<footer id="post-meta" class="clearfix">
    <a href="https://twitter.com/radareorg">
    <img class="avatar" src="https://radareorg.github.io/blog/images/avatar.png">
    <div>
        <span class="dark">The radare team</span>
        <span></span>
    </div>
    </a>
    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fradareorg.github.io%2fblog%2fposts%2fmalware-static-analysis%2f - Retrieving%20configuration%20of%20a%20Remote%20Administration%20Tool%20%28Malware%29%20with%20radare2%20statically by @radareorg"><span class="icon-twitter"> https://twitter.com/radareorg</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

    </section>
</footer>



<ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/sleigh_disassembler_backend/">GSoC 2020: SLEIGH Disassembler Backend<aside class="dates">Sep 6 2020</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/rsoc-2019-console-interface-improvement/">RSoC 2019 Final: Console Interface Improvements<aside class="dates">Oct 1 2019</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/rsoc-2019-selection/">Radare2 Summer of Code 2019 Selection Results<aside class="dates">Apr 2 2019</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/radare2-survey/">Radare2 Community Survey Results<aside class="dates">Feb 2 2019</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/radare2-bioinformatics/">Radare2 and bioinformatics: a good match?<aside class="dates">Aug 31 2018</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/cutter_debug/">GSoC 2018 Final: Debugging and Emulation Support for Cutter<aside class="dates">Aug 20 2018</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/cli_improvements/">GSoC 2018 Final: Console Interface Improvementes<aside class="dates">Aug 19 2018</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/gsoc_2018_radeco_cfs/">GSoC 2018: Control Flow Structuring for Radeco-lib<aside class="dates">Aug 12 2018</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/gsoc_2018_radeco_pseudo_c_code_generation/">Gsoc 2018 Radeco Pseudo C Code Generation<aside class="dates">Aug 12 2018</aside></a>
        </li>
    
        <li>
            <a href="https://radareorg.github.io/blog/posts/type_inference/">GSoC&#39;18 Final: Type inference<aside class="dates">Aug 12 2018</aside></a>
        </li>
    
</ul>



        <footer id="footer">
    
    <p class="small">
    
        The radare team
    
    </p>
</footer>

    </section>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://radareorg.github.io/blog/js/main.js"></script>
<script src="https://radareorg.github.io/blog/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>





</body>
</html>
